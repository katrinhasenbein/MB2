---
title: "sf_packages"
output: ioslides_presentation
widescreen: yes
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(comment = "") 
setwd("C:/Users/katri/Documents/Uni/MB2 Introduction to Programming and Geostatistics/Git")
```

#Introduction into the R   "sf package"

## What is the package about?
###What are simple features?
feature = real world *thing*  
set of features can form a single feature
characteristics of features:  
- geometry (coordinate points in 1- to 4D)
    * longitude
    * latitude
    * altitude
    * measure (e.g. time, error of coordinates)
- attributes  
    
**simple features** have spatial and non-spatial attributes

##
###feature types
- point
- linestring
- polygon
- multipoint
- multilinestring
- multipolygon
- geometrycollection
- ...

## Organisation of sf in R
Package sf represents simple features as native R objects  
(<--> sp: defines new classes)  
--> simple data structures  
--> attributes and geometry stored in data.frame (geometry in list-column)
  
  
- functionality similar to *sp*
- but no new classes defined, it extends data.frames (**native** classes!)

##Potential of sf to replace sp
- simpler data structures
- simpler handling of CRS
- ability to return distance or area values with proper units (meter, feet or US feet)
- support for geosphere functions to compute distances or areas for longitude/latitude data

## Get started with sf
```{r}
#install the package
install.packages("sf", repos="http://cran.rstudio.com/", quiet = TRUE)
#install development versions
library(devtools)
install_github("r-spatial/sf", quiet = TRUE)
library(sf)
```

##Example data: North Carolina counties
```{r}
#read sf objects with st_read
nc <- st_read(system.file("shape/nc.shp", package = "sf"))
```

##
```{r, echo = FALSE}
#plot attribute 1
par(mar=c(0,0,1,0))
plot(nc[1])
```


##
```{r}
class(nc)
head(nc)
```



## Some useful commands
```{r}
#methods of sf objects
methods(class = "sf")
```

##
```{r}
#convert sf object to data.frame
nc.no_sf <- as.data.frame(nc)
class(nc.no_sf)

#access geometry list-column
(nc_geom <- st_geometry(nc))
nc_geom [[1]]

#methods for geometry list-columns (sfc)
methods(class = "sfc")

#attributes of sfc
attributes(nc_geom)
```

*sfc* object: simple feature geometry list-column  
*sfg* object: simple feature geometry --> geometry for a single feature



## Creating some sf objects
```{r}
## MULTIPOINT
p <- rbind(c(3.2,4), c(3,4.6), c(3.8,4.4), c(3.5,3.8), c(3.4,3.6), c(3.9,4.5))
(mp <- st_multipoint(p))

## LINESTRING 
s1 <- rbind(c(0,3),c(0,4),c(1,5),c(2,5))
(ls <- st_linestring(s1))

## MULTILINESTRING 
s2 <- rbind(c(0.2,3), c(0.2,4), c(1,4.8), c(2,4.8))
s3 <- rbind(c(0,4.4), c(0.6,5))
(mls <- st_multilinestring(list(s1,s2,s3)))

## MULTIPOLYGON  
p1 <- rbind(c(0,0), c(1,0), c(3,2), c(2,4), c(1,4), c(0,0))
p2 <- rbind(c(1,1), c(1,2), c(2,2), c(1,1))
pol <-st_polygon(list(p1,p2))
p3 <- rbind(c(3,0), c(4,0), c(4,1), c(3,1), c(3,0))
p4 <- rbind(c(3.3,0.3), c(3.8,0.3), c(3.8,0.8), c(3.3,0.8), c(3.3,0.3))[5:1,]
p5 <- rbind(c(3,3), c(4,2), c(4,3), c(3,3))
(mpol <- st_multipolygon(list(list(p1,p2), list(p3,p4), list(p5))))

## GEOMETRYCOLLECTION
(gc <- st_geometrycollection(list(mp, mpol, ls)))
```

##
```{r}
par(mfrow = c(2,3))
plot(mp, main = "Multipoint"); plot(ls, main = "Linestring"); plot(mls, main = "Multilinestring"); plot(pol, main = "Polygon"); plot(mpol, main = "Multipoygon"); plot(gc, main = "Geometrycollection")
```

## Reading and writing
```{r}
#read sf object with st_read
filename <-  system.file("shape/nc.shp", package = "sf") #ESRI Shapefile
file <- st_read(filename, quiet = TRUE)

#write file with st_write
st_write(nc, "nc.shp", driver = "ESRI Shapefile")
```
--> multiple formats possible (also lists with several layers)  
--> reading and writing directly from and to spatial databases possible





# Manipulating simple features geometries
## Type transformations
st_cast:   
- single geometries into multi-geometries or vice versa  
- geometrycollection into its component (if length = 1)

##Affine transformations
f(x) = xA + b
--> flatten, scale, rotate and translate

```{r}
#rotate 90% clockwise around centroid
#shrink to 75% of their originial size
cntrd = st_centroid(nc_geom)
rot = function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)),2,2)
nc_geom2 = (nc_geom - cntrd)*rot(pi/2) * .75+cntrd

```

##
```{r, echo = FALSE}
plot(nc_geom, border = "grey"); plot(nc_geom2, add=TRUE)
```

## Transformations and conversions
```{r}
#CRS transformation
nc.web_mercator <- st_transform(nc, 3857)
#Conversion to sp object
nc.sp <- as(nc, "Spatial")
```

## Geometrical operations

```{r}
#creating geomtry set 1 with 4 polygons 
b0 = st_polygon(list(rbind(c(-1,-1), c(1,-1), c(1,1), c(-1,1), c(-1,-1))))
b1 = b0 + 2
b2 = b0 + c(-0.2, 2)
x = st_sfc(b0, b1, b2)
#creating geometry set 2 with four polygons
a0 = b0 * 0.8
a1 = a0 * 0.5 + c(2, 0.7)
a2 = a0 + 1
a3 = b0 * 0.5 + c(2, -0.5)
y = st_sfc(a0,a1,a2,a3)
```

##
```{r, echo = FALSE}
plot(x, border = 'red');
plot(y, border = 'green', add = TRUE)
```

## Measuring
```{r}
#area of polygons
st_area(x)
#length of geometries
st_length(st_sfc(st_linestring(rbind(c(0,0), c(1,1), c(1,2))), st_linestring(rbind(c(0,0), c(1,0)))))
```

```{r}
#shortest distance matrix between geometries
st_distance(x,y)
```



## Test topology
```{r}
#check if geometries are topologically valid
b1 = st_polygon(list(rbind(c(-1,-1), c(1,-1), c(1,1), c(0,-1), c(-1,-1))))

```

```{r, echo = FALSE}
par(mfrow = c(1,2))
plot(b0, main = "valid topology")
plot(b1, main = "invalid topology")
```

##
```{r}
st_is_valid(st_sfc(b0, b1))
```


##
```{r}
#intersection between objects
st_intersects(x,y)
st_intersects(x,y, sparse = FALSE)
```
other operations:  
- st_disjoint
- st_touches
- st_crosses
- st_within
- st_contains
- st_overlaps
- st_covers
- ...

##Return new geometries
```{r}
#union objects
u = st_union(x)
plot(u)
```

##
```{r}
#buffer objects
plot(st_buffer(u, 0.2)); plot(u, border = "red", add = TRUE)
```

##
```{r}
plot(st_convex_hull(u))
```

##
```{r, echo = FALSE}
plot(x); plot(st_centroid(u), col = "red",  add = TRUE)
```

##
```{r}
plot(x); plot(y, add = TRUE);plot(st_intersection(st_union(x), st_union(y)), add = TRUE, col = "red")
```
other operations  
- st_difference
- st_segmentize
- st_polygonize
- ...



# Manipulation simple features
##
- subset features (using []) 
- aggregating feature sets (aggregate())
- joining two feature sets beased on attributes or feature geometry (merge(), st_join())

# Plotting Simple Features
##Geometry only
```{r}
plot(st_geometry(nc))
```

##Geometry with attributes
```{r}
plot(nc, max.plot = 6)
```

## Visualising
- color keys
- class intervals
- display axes

##Plotting with other packages
- st_as_grob ("gaphic objects")
- ggplot2
- mapview
- tmap


## References
- https://github.com/r-spatial/sf
- https://www.r-consortium.org/blog/2017/01/03/simple-features-now-on-cran